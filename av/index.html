<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>RSS Reader Pro</title>

<style>
:root{--bg:#fff;--text:#111;--card:#f2f2f2;--accent:#0066cc}
@media(prefers-color-scheme:dark){:root{--bg:#121212;--text:#eee;--card:#1e1e1e;--accent:#4da3ff}}
body{margin:0;font-family:system-ui;background:var(--bg);color:var(--text)}
header{padding:1rem;text-align:center;font-size:1.2rem;font-weight:bold}
main{max-width:960px;margin:auto;padding:1rem}
.controls{display:grid;gap:.6rem;margin-bottom:1rem}
input,select{padding:.6rem;border-radius:10px;border:1px solid #888;background:var(--card);color:var(--text)}
.item{background:var(--card);border-radius:16px;margin-bottom:1rem;overflow:hidden;box-shadow:0 2px 6px rgba(0,0,0,.08)}
.thumb{width:100%;aspect-ratio:16/9;object-fit:cover;background:#000}
.content{padding:.8rem}
.title{font-weight:bold;color:var(--accent);text-decoration:none;display:block;margin-bottom:.4rem}
.meta{font-size:.8rem;opacity:.65;display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
.icon{width:14px;height:14px;vertical-align:-2px;fill:currentColor}
#status{text-align:center;opacity:.6;margin:1rem}
</style>
</head>

<body>
<header>ğŸ“¡ RSS Reader Pro</header>

<main>
  <div class="controls">
    <input id="search" placeholder="ğŸ” æœå°‹é—œéµå­—">
    <select id="sourceFilter">
      <option value="all">ğŸ“š æ‰€æœ‰ä¾†æº</option>
      <option value="18AV">18AV</option>
      <option value="Hanime1">Hanime1</option>
      <option value="Ero-Video">Ero-Video</option>
    </select>
    <select id="lang">
      <option value="zh">ğŸ‡¹ğŸ‡¼ ç¹ä¸­</option>
      <option value="en">ğŸ‡ºğŸ‡¸ English</option>
      <option value="raw">åŸæ–‡</option>
    </select>
  </div>

  <div id="status">è¼‰å…¥ä¸­...</div>
  <div id="feed"></div>
</main>

<!-- SVG ICON SPRITE -->
<svg style="display:none">
  <symbol id="i-clock" viewBox="0 0 24 24"><path d="M12 1a11 11 0 1 0 11 11A11 11 0 0 0 12 1Zm1 11.4 3.3 2-.6 1-3.9-2.4V6h1.2Z"/></symbol>
  <symbol id="i-source" viewBox="0 0 24 24"><path d="M4 4h16v2H4zm0 7h10v2H4zm0 7h16v2H4z"/></symbol>
</svg>

<script>
// =======================
// Service Worker é›¢ç·š
// =======================
if("serviceWorker" in navigator){
  const sw=`
    self.addEventListener("install",e=>e.waitUntil(caches.open("rss-pro").then(c=>c.addAll(["./"]))));
    self.addEventListener("fetch",e=>e.respondWith(caches.match(e.request).then(r=>r||fetch(e.request))));
  `;
  navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw])));
}

// =======================
// IndexedDB ç¿»è­¯å¿«å–
// =======================
const req=indexedDB.open("rss-db",1);
let db;
req.onupgradeneeded=e=>e.target.result.createObjectStore("t",{keyPath:"k"});
req.onsuccess=e=>db=e.target.result;

const getCache=k=>new Promise(r=>{
  if(!db) return r(null);
  const q=db.transaction("t").objectStore("t").get(k);
  q.onsuccess=()=>r(q.result?.v||null);
});
const setCache=(k,v)=>db&&db.transaction("t","readwrite").objectStore("t").put({k,v});

// =======================
// ç¿»è­¯
// =======================
async function translate(text,target){
  if(target==="raw") return text;
  const key=target+"|"+text;
  const cached=await getCache(key);
  if(cached) return cached;

  const res=await fetch("https://libretranslate.de/translate",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({q:text,source:"auto",target})
  }).then(r=>r.json()).catch(()=>null);

  const out=res?.translatedText||text;
  setCache(key,out);
  return out;
}

// =======================
// RSS
// =======================
const feeds=[
  {name:"18AV",url:"https://rss.app/feeds/eS2iB3hy0gfoMeSW.xml"},
  {name:"Hanime1",url:"https://rss.app/feeds/FuIYGgvZZ4yvY9js.xml"},
  {name:"Ero-Video",url:"https://rss.app/feeds/lrJwczmeZYPaSWFl.xml"}
];
const proxy="https://api.rss2json.com/v1/api.json?rss_url=";

const container=document.getElementById("feed");
const status=document.getElementById("status");
const search=document.getElementById("search");
const filter=document.getElementById("sourceFilter");
const lang=document.getElementById("lang");

let all=[];

function pickImage(item){
  return item.thumbnail 
      || item.enclosure?.link 
      || item["media:content"]?.url 
      || "";
}

async function load(){
  const mode=lang.value;
  const res=await Promise.all(feeds.map(f=>
    fetch(proxy+encodeURIComponent(f.url))
      .then(r=>r.json())
      .then(d=>Promise.all(d.items.map(async i=>({
        raw:i.title,
        title:await translate(i.title,mode),
        link:i.link,
        img:pickImage(i),
        source:f.name,
        date:new Date(i.pubDate||Date.now())
      }))))
  ));
  all=res.flat().sort((a,b)=>b.date-a.date);
  status.remove();
  render(all);
}

function render(data){
  container.innerHTML="";
  data.forEach(i=>{
    const div=document.createElement("div");
    div.className="item";
    div.innerHTML=`
      ${i.img?`<img class="thumb" src="${i.img}" loading="lazy">`:""}
      <div class="content">
        <a class="title" href="${i.link}" target="_blank">${i.title}</a>
        <div class="meta">
          <span><svg class="icon"><use href="#i-source"/></svg> ${i.source}</span>
          <span><svg class="icon"><use href="#i-clock"/></svg> ${i.date.toLocaleString()}</span>
        </div>
        <div class="meta"><small>${i.raw}</small></div>
      </div>
    `;
    container.appendChild(div);
  });
}

function apply(){
  const kw=search.value.toLowerCase().split(/\s+/).filter(Boolean);
  const src=filter.value;
  render(all.filter(i=>(src==="all"||i.source===src)&&kw.every(k=>i.title.toLowerCase().includes(k))));
}

search.oninput=apply;
filter.onchange=apply;
lang.onchange=load;

load();
</script>
</body>
</html>