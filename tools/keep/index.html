<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<title>è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰</title>
<meta name="description" content="è«æ¯”ç©ºé–“ Mobispace ç§å¯†ç­†è¨˜ Ã— ç™¼å¸ƒå¼•æ“">
<meta name="robots" content="index,follow">

<!-- ===== Open Graph é è¨­å€¼ï¼ˆç™¼å¸ƒæ™‚æœƒè¢«å‹•æ…‹å–ä»£ï¼‰ ===== -->
<meta property="og:title" content="è«æ¯”æ–‡ä»¶" />
<meta property="og:description" content="ç”± Mobispace ç™¼å¸ƒçš„ç­†è¨˜å…§å®¹" />
<meta property="og:type" content="article" />
<meta property="og:url" content="" />
<meta property="og:image" content="https://x-easy.github.io/og-default.png" />

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>

<style>
body { margin:0; background:#000; color:#eee; font-family:"Noto Sans TC", system-ui; }
#mobispace-editor { max-width:1100px; margin:auto; padding:20px; }
.editor-main { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:768px){ .editor-main { grid-template-columns:1fr; } }
textarea,#preview,input { background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:12px; }
textarea,#preview { min-height:280px; }
.toolbar { display:flex; flex-wrap:wrap; gap:8px; margin:12px 0; }
select,input,button { background:#111;color:#fff;border:1px solid #333;border-radius:6px;padding:6px; }
#tabBar { display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:12px; }
.tab { background:#333;border:none;border-radius:6px;padding:6px 10px;color:#fff;cursor:pointer; }
.tab.active { background:#4caf50; }
</style>
</head>

<body>
<section id="mobispace-editor">

<h2 style="text-align:center">è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰</h2>

<!-- ===== å·¥å…·åˆ— ===== -->
<div class="toolbar">

  <!-- âœï¸ æ¯ç­†ç­†è¨˜çš„æ¨™é¡Œï¼ˆç›´æ¥ç´å…¥è³‡æ–™æ¨¡å‹ï¼‰ -->
  <input id="titleInput" placeholder="ç­†è¨˜æ¨™é¡Œï¼ˆç”¨æ–¼ç®¡ç† / SEO / OGï¼‰" />

  <!-- ğŸ“¥ åŒ¯å…¥æª”æ¡ˆï¼ˆæ”¯æ´ md/txt/html/xml/zip/ä»»æ„ç´”æ–‡å­—ï¼‰ -->
  <input type="file" id="importFile" multiple />

  <select id="formatSelect">
    <option value="md">ä¸‹è¼‰ .md</option>
    <option value="txt">ä¸‹è¼‰ .txt</option>
    <option value="html">ä¸‹è¼‰ .html</option>
    <option value="xml">ä¸‹è¼‰ .xml</option>
    <option value="zip">ä¸‹è¼‰ .zip</option>
  </select>

  <select id="scopeSelect">
    <option value="single">å–®é </option>
    <option value="all">å…¨éƒ¨é é¢</option>
  </select>

  <input id="filenameInput" placeholder="æª”å" />
  <button onclick="download()">â¬‡ï¸ åŸ·è¡Œä¸‹è¼‰</button>
  <button onclick="publishHTML()">ğŸŒ SEO Publish</button>
</div>

<div class="editor-main">
  <textarea id="textArea" placeholder="è¼¸å…¥ Markdown..."></textarea>
  <div id="preview">Preview</div>
</div>

<div id="tabBar"></div>

<script>
/* ================= IndexedDB è³‡æ–™å±¤ ================= */
const DB="mobispaceDB", STORE="notes";
let db, current=1, tabs=[1];

indexedDB.open(DB,2).onupgradeneeded=e=>{
  e.target.result.createObjectStore(STORE,{keyPath:"id"});
};

indexedDB.open(DB,2).onsuccess=e=>{
  db=e.target.result;
  load(1); renderTabs();
};

const ta=textArea, prev=preview, titleEl=titleInput;

/* æ¯æ¬¡è¼¸å…¥å³åŒæ­¥å„²å­˜å…§å®¹èˆ‡æ¨™é¡Œ */
ta.oninput = titleEl.oninput = ()=>{
  prev.innerHTML = marked.parse(ta.value); // Markdown â†’ HTML é è¦½
  save(); // åŒæ­¥ä¿å­˜è³‡æ–™
};

/* å„²å­˜è³‡æ–™ï¼šid + title + content */
function save(){
  db.transaction(STORE,"readwrite").objectStore(STORE)
    .put({id:current,title:titleEl.value||`Note ${current}`,content:ta.value});
}

/* è¼‰å…¥æŒ‡å®šç­†è¨˜ */
function load(id){
  db.transaction(STORE).objectStore(STORE)
    .get(id).onsuccess=e=>{
      const note=e.target.result;
      titleEl.value=note?.title||`Note ${id}`;
      ta.value=note?.content||"";
      prev.innerHTML = marked.parse(ta.value);
    };
}

/* Tabs UI */
function renderTabs(){
  tabBar.innerHTML="";
  tabs.forEach(id=>{
    const b=document.createElement("button");
    b.className="tab"+(id===current?" active":"");
    b.textContent=id;
    b.onclick=()=>{current=id;load(id);renderTabs();}
    tabBar.appendChild(b);
  });
}

/* åŒ¯å…¥æª”æ¡ˆé‚è¼¯ */
importFile.onchange=async ()=>{
  for(const file of importFile.files){
    const text = await file.text(); // æ‰€æœ‰æ–‡å­—æ ¼å¼ fallback çš†å¯è®€å–
    const id = tabs.length+1;
    tabs.push(id);
    db.transaction(STORE,"readwrite").objectStore(STORE)
      .put({id,title:file.name,content:text});
  }
  renderTabs();
};

/* æ”¶é›†å…¨éƒ¨ç­†è¨˜ */
async function collectAllNotes(){
  return new Promise(res=>{
    const out=[];
    const tx=db.transaction(STORE);
    tx.objectStore(STORE).openCursor().onsuccess=e=>{
      const c=e.target.result;
      if(c){ out.push(c.value); c.continue(); }
      else res(out.sort((a,b)=>a.id-b.id));
    };
  });
}

/* ZIP åŒ¯å‡º */
async function exportZIP(notes){
  const zip=new JSZip();
  notes.forEach(n=>{
    zip.file(`${n.title||"note-"+n.id}.md`,n.content);
  });
  const blob=await zip.generateAsync({type:"blob"});
  trigger(blob,`${filenameInput.value||"notes"}.zip`);
}

/* XML åŒ¯å‡º */
async function exportXML(notes){
  let xml=`<?xml version="1.0" encoding="UTF-8"?><notes>`;
  notes.forEach(n=>{
    xml+=`<note id="${n.id}" title="${n.title}"><![CDATA[${n.content}]]></note>`;
  });
  xml+=`</notes>`;
  trigger(new Blob([xml],{type:"application/xml"}),`${filenameInput.value||"notes"}.xml`);
}

/* ä¸»ä¸‹è¼‰æ§åˆ¶å™¨ */
async function download(){
  const scope=scopeSelect.value;
  const format=formatSelect.value;
  const notes = scope==="single"
    ? [{id:current,title:titleEl.value,content:ta.value}]
    : await collectAllNotes();

  if(format==="zip") return exportZIP(notes);
  if(format==="xml") return exportXML(notes);

  if(notes.length>1){
    const zip=new JSZip();
    notes.forEach(n=>zip.file(`${n.title}.${format}`,n.content));
    const blob=await zip.generateAsync({type:"blob"});
    return trigger(blob,`${filenameInput.value||"notes"}.zip`);
  }

  trigger(new Blob([notes[0].content]),`${filenameInput.value||notes[0].title}.${format}`);
}

/* SEO Publishï¼ˆå« OG tagsï¼‰ */
function publishHTML(){
  const title = titleEl.value||"è«æ¯”æ–‡ä»¶";
  const desc = ta.value.slice(0,120).replace(/\n/g," ");
  const html = `
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>${title}</title>
<meta name="description" content="${desc}">
<meta property="og:title" content="${title}">
<meta property="og:description" content="${desc}">
<meta property="og:type" content="article">
<meta property="og:image" content="https://x-easy.github.io/og-default.png">
</head>
<body>
<article>${marked.parse(ta.value)}</article>
</body>
</html>`;
  trigger(new Blob([html]),`${filenameInput.value||title}.html`);
}

/* é€šç”¨ä¸‹è¼‰å™¨ */
function trigger(blob,filename){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}
</script>
</body>
</html>
