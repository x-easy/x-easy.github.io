<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />

<title>Mobispace Flagship Editor</title>

<!-- Markdown æ¸²æŸ“æ ¸å¿ƒï¼šmarked.jsï¼ˆç´”å‰ç«¯å³æ™‚è½‰ HTMLï¼‰ -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Monaco Editor CDN Loader -->
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<style>
/* ============================= */
/* Mobispace Editor Flagship CSS */
/* ============================= */

body {
  background:#000;
  color:#eee;
  font-family:"Noto Sans TC",system-ui;
}

#mobispace-editor {
  max-width:900px;
  margin:40px auto;
  padding:20px;
  border:1px solid #333;
  border-radius:12px;
  background:#111;
}

/* Tab åˆ—å®¹å™¨ */
#tabBar {
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:center;
  margin-bottom:10px;
}

/* å–®ä¸€ Tab æ¨£å¼ */
.tab {
  padding:6px 10px;
  background:#444;
  border:none;
  border-radius:6px;
  color:#fff;
  cursor:pointer;
}
.tab.active { background:#4caf50; }

/* æ–°å¢åˆ†é æŒ‰éˆ• */
#addTab {
  background:#2196f3;
}

/* å·¥å…·åˆ— */
.toolbar {
  text-align:center;
  margin:10px 0;
}

/* ç·¨è¼¯å™¨å€å¡Š */
#editorContainer {
  display:flex;
  gap:10px;
  min-height:300px;
}

/* åŸç”Ÿ textarea æ¨¡å¼ */
#textArea {
  flex:1;
  background:#222;
  color:#fff;
  border:1px solid #333;
  border-radius:8px;
  padding:10px;
}

/* Markdown é è¦½å€ */
#preview {
  flex:1;
  background:#181818;
  border:1px solid #333;
  border-radius:8px;
  padding:10px;
  overflow:auto;
}

/* Monaco Editor å®¹å™¨ */
#monaco {
  height:400px;
  display:none;
  border:1px solid #333;
  border-radius:8px;
  overflow:hidden;
}

button {
  padding:6px 12px;
  border-radius:6px;
  border:none;
  cursor:pointer;
}
</style>
</head>

<body>

<section id="mobispace-editor">

<h2 style="text-align:center">â²˜ğ”¬â³ğ”­â²ğ” â²‰ Flagship Editor</h2>

<!-- åˆ†é åˆ—ï¼ˆé è¨­åƒ…ä¸€é ï¼‰ -->
<div id="tabBar">
  <button class="tab active" data-id="1">1</button>
  <button id="addTab">ï¼‹</button>
</div>

<!-- å·¥å…·åˆ— -->
<div class="toolbar">
  <button id="toggleMode">åˆ‡æ› Monaco æ¨¡å¼</button>
  <button id="saveBtn">ä¸‹è¼‰</button>
  <button id="clearBtn">æ¸…ç©º</button>
</div>

<!-- ç·¨è¼¯å™¨ä¸»é«” -->
<div id="editorContainer">

  <!-- åŸç”Ÿè¼¸å…¥ -->
  <textarea id="textArea" placeholder="Markdown / æ–‡å­—è¼¸å…¥..."></textarea>

  <!-- Markdown é è¦½ -->
  <div id="preview">Markdown Preview</div>
</div>

<!-- Monaco Editor å°ˆç”¨å®¹å™¨ -->
<div id="monaco"></div>

<p id="status" style="text-align:center;font-size:13px;color:#888;">Ready</p>

</section>

<script>
/* =========================================================
   Mobispace Flagship Editor Engine
   åŠŸèƒ½æ¨¡çµ„ï¼š
   - IndexedDB å„²å­˜
   - å‹•æ…‹åˆ†é 
   - Markdown å³æ™‚æ¸²æŸ“
   - Monaco Editor åˆ‡æ›
   - é›¢ç·šæ”¯æ´ï¼ˆService Workerï¼‰
========================================================= */

/* ------------------------
   IndexedDB åˆå§‹åŒ–
------------------------ */
const DB_NAME = "mobispace_db";           // è³‡æ–™åº«åç¨±
const STORE = "notes";                   // å„²å­˜å€åç¨±
let db;                                  // å…¨åŸŸè³‡æ–™åº«å¯¦ä¾‹

const request = indexedDB.open(DB_NAME, 1); // å»ºç«‹/æ‰“é–‹è³‡æ–™åº«

request.onupgradeneeded = e => {
  db = e.target.result;
  db.createObjectStore(STORE, { keyPath: "id" }); // æ¯ç­†è³‡æ–™ç”¨ id ç•¶ key
};

request.onsuccess = e => {
  db = e.target.result;
  loadNote(1); // é è¨­åªè¼‰å…¥ç¬¬ä¸€é 
};

/* ------------------------
   ç‹€æ…‹æ§åˆ¶
------------------------ */
let currentTab = 1;      // ç•¶å‰åˆ†é 
let tabCount = 1;        // é æ•¸è¨ˆæ•¸å™¨
let monacoEditor = null; // Monaco å¯¦ä¾‹
let monacoMode = false;  // æ˜¯å¦å•Ÿç”¨ Monaco

const textArea = document.getElementById("textArea");
const preview = document.getElementById("preview");
const status = document.getElementById("status");

/* ------------------------
   Markdown å³æ™‚æ¸²æŸ“
------------------------ */
textArea.addEventListener("input", () => {
  preview.innerHTML = marked.parse(textArea.value); // å³æ™‚æ¸²æŸ“ Markdown
  saveNote();                                       // æ¯æ¬¡è¼¸å…¥å³è‡ªå‹•å„²å­˜
});

/* ------------------------
   IndexedDB å„²å­˜
------------------------ */
function saveNote() {
  const tx = db.transaction(STORE, "readwrite");
  const store = tx.objectStore(STORE);

  store.put({
    id: currentTab,
    content: monacoMode ? monacoEditor.getValue() : textArea.value
  });

  status.textContent = "å·²å„²å­˜ (IndexedDB)";
}

/* ------------------------
   IndexedDB è¼‰å…¥
------------------------ */
function loadNote(id) {
  const tx = db.transaction(STORE, "readonly");
  const store = tx.objectStore(STORE);
  const req = store.get(id);

  req.onsuccess = () => {
    const data = req.result?.content || "";
    textArea.value = data;
    preview.innerHTML = marked.parse(data);
    if (monacoEditor) monacoEditor.setValue(data);
  };
}

/* ------------------------
   åˆ†é æ–°å¢
------------------------ */
document.getElementById("addTab").onclick = () => {
  tabCount++;
  const btn = document.createElement("button");
  btn.className = "tab";
  btn.dataset.id = tabCount;
  btn.textContent = tabCount;

  btn.onclick = () => switchTab(tabCount);

  document.getElementById("tabBar").insertBefore(btn, document.getElementById("addTab"));
};

/* ------------------------
   åˆ‡æ›åˆ†é 
------------------------ */
function switchTab(id) {
  document.querySelectorAll(".tab").forEach(t => t.classList.remove("active"));
  document.querySelector(`[data-id="${id}"]`).classList.add("active");
  currentTab = id;
  loadNote(id);
}

/* ------------------------
   Monaco Editor åˆå§‹åŒ–
------------------------ */
require.config({ paths: { vs: "https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs" }});
require(["vs/editor/editor.main"], () => {

  monacoEditor = monaco.editor.create(document.getElementById("monaco"), {
    value: "",
    language: "markdown",
    theme: "vs-dark",
    automaticLayout: true
  });

  monacoEditor.onDidChangeModelContent(() => saveNote());
});

/* ------------------------
   æ¨¡å¼åˆ‡æ›
------------------------ */
document.getElementById("toggleMode").onclick = () => {
  monacoMode = !monacoMode;

  if (monacoMode) {
    document.getElementById("editorContainer").style.display = "none";
    document.getElementById("monaco").style.display = "block";
    monacoEditor.setValue(textArea.value);
  } else {
    document.getElementById("editorContainer").style.display = "flex";
    document.getElementById("monaco").style.display = "none";
    textArea.value = monacoEditor.getValue();
  }
};

/* ------------------------
   æ¸…ç©º
------------------------ */
document.getElementById("clearBtn").onclick = () => {
  if(confirm("æ¸…ç©ºç›®å‰åˆ†é ï¼Ÿ")){
    textArea.value = "";
    preview.innerHTML = "";
    saveNote();
  }
};

/* ------------------------
   ä¸‹è¼‰æª”æ¡ˆ
------------------------ */
document.getElementById("saveBtn").onclick = () => {
  const content = monacoMode ? monacoEditor.getValue() : textArea.value;
  const blob = new Blob([content], {type:"text/plain"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `mobispace_tab_${currentTab}.md`;
  a.click();
};

/* ------------------------
   é›¢ç·šæ”¯æ´ Service Worker
------------------------ */
if ("serviceWorker" in navigator) {

  // å‹•æ…‹å»ºç«‹ SW æª”æ¡ˆå…§å®¹ï¼ˆé¿å…æ‹†æª”ï¼‰
  const swCode = `
    self.addEventListener('install', e => self.skipWaiting());
    self.addEventListener('fetch', e => {});
  `;

  const blob = new Blob([swCode], { type: "text/javascript" });
  const swUrl = URL.createObjectURL(blob);

  navigator.serviceWorker.register(swUrl);
}
</script>

</body>
</html>
