<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ================= SEO / èªæ„æ ¸å¿ƒ ================= -->
<title>è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰</title>
<meta name="description" content="è«æ¯”ç©ºé–“ Mobispace ç§å¯†ç­†è¨˜ Ã— ç™¼å¸ƒå¼•æ“ Ã— åŠ å¯†ä¸‹è¼‰">
<meta name="robots" content="index,follow">

<!-- ================= å‹•æ…‹ç¶²ç«™åç¨±è¼ªæ’­ ================= -->
<script>
const titles = [
  "è«æ¯”æ–‡ä»¶",
  "ç©ºé–“ç·¨è¼¯å™¨",
  "â²˜â³ç·¨è¼¯å™¨",
  "â²˜ğ”¬â²ƒÂ¡ kâ²‰â²‰ğ”­",
  "â³ğ”­â²ğ” â²‰ Nğ”¬tâ²‰",
  "è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰"
];
let tIndex = Math.floor(Math.random()*titles.length);
setInterval(()=>{ document.title = titles[tIndex++ % titles.length]; }, 4000);
</script>

<!-- ================= CDN libs ================= -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<style>
body { margin:0; background:#000; color:#eee; font-family:"Noto Sans TC", system-ui; }
#mobispace-editor { max-width:1100px; margin:auto; padding:20px; }
.editor-main { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
@media(max-width:768px){ .editor-main { grid-template-columns:1fr; } }
textarea,#preview,#monaco { background:#111;color:#fff;border:1px solid #333;border-radius:10px;padding:12px;min-height:280px; }
.toolbar { display:flex; flex-wrap:wrap; gap:8px; margin:12px 0; }
select,input,button { background:#111;color:#fff;border:1px solid #333;border-radius:6px;padding:6px; }
#tabBar { display:flex;gap:6px;flex-wrap:wrap;justify-content:center;margin-top:12px; }
.tab { background:#333;border:none;border-radius:6px;padding:6px 10px;color:#fff;cursor:pointer; }
.tab.active { background:#4caf50; }
footer { margin-top:40px;text-align:center;font-size:13px;color:#666; }
footer a { color:#888;text-decoration:none; }
footer a:hover { text-decoration:underline; }
</style>
</head>

<body>
<section id="mobispace-editor">

<h2 style="text-align:center">è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰</h2>

<!-- ================= å·¥å…·åˆ— ================= -->
<div class="toolbar">
  <select id="modeSelect">
    <option value="normal">ä¸€èˆ¬æ¨¡å¼</option>
    <option value="monaco">IDE æ¨¡å¼</option>
  </select>

  <select id="formatSelect">
    <option value="md">ä¸‹è¼‰ .md</option>
    <option value="txt">ä¸‹è¼‰ .txt</option>
    <option value="html">ä¸‹è¼‰ .html</option>
  </select>

  <input id="filenameInput" placeholder="æª”å" />

  <select id="actionSelect">
    <option value="">æ“ä½œ</option>
    <option value="add">æ–°å¢ç­†è¨˜</option>
    <option value="delete">åˆªé™¤ç­†è¨˜</option>
    <option value="publish">ä¸€éµç™¼å¸ƒæ–‡ç« é </option>
  </select>

  <!-- ğŸ” åŠ å¯†ä¸‹è¼‰æŒ‰éˆ•ï¼ˆæ–°åŠŸèƒ½æ ¸å¿ƒï¼‰ -->
  <button onclick="downloadEncrypted()">ğŸ” åŠ å¯†ä¸‹è¼‰</button>

  <!-- â¬‡ï¸ ä¸€èˆ¬ä¸‹è¼‰æŒ‰éˆ• -->
  <button onclick="download()">â¬‡ï¸ åŸ·è¡Œä¸‹è¼‰</button>
</div>

<div class="editor-main">
  <textarea id="textArea" placeholder="è¼¸å…¥ Markdown..."></textarea>
  <div id="preview">Preview</div>
</div>

<div id="monaco" style="display:none;"></div>
<div id="tabBar"></div>

<p id="status" style="text-align:center;font-size:13px;color:#777;">Mobispace Engine Ready</p>

<footer>
  <a href="https://x-easy.github.io" target="_blank">
    è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰ â€¢ 2025
  </a>
</footer>

</section>

<script>
/* ================= IndexedDB è³‡æ–™å±¤ ================= */
const DB="mobispaceDB", STORE="notes";
let db, current=1, tabs=[1];

indexedDB.open(DB,1).onupgradeneeded=e=>{
  e.target.result.createObjectStore(STORE,{keyPath:"id"}); // å»ºç«‹ notes è¡¨
};
indexedDB.open(DB,1).onsuccess=e=>{
  db=e.target.result;
  load(1); renderTabs();
};

const ta=textArea, prev=preview;

/* ================= Markdown å³æ™‚æ¸²æŸ“ ================= */
ta.oninput=()=>{
  prev.innerHTML = marked.parse(ta.value); // Markdown â†’ HTML
  save(); // æ¯æ¬¡è¼¸å…¥å³å¯«å…¥ IndexedDB
};

function save(){
  db.transaction(STORE,"readwrite").objectStore(STORE)
    .put({id:current,content:ta.value});
}

function load(id){
  db.transaction(STORE).objectStore(STORE)
    .get(id).onsuccess=e=>{
      ta.value=e.target.result?.content||"";
      prev.innerHTML = marked.parse(ta.value);
    };
}

/* ================= Tabs ================= */
function renderTabs(){
  tabBar.innerHTML="";
  tabs.forEach(id=>{
    const b=document.createElement("button");
    b.className="tab"+(id===current?" active":"");
    b.textContent=id;
    b.onclick=()=>{current=id;load(id);renderTabs();}
    tabBar.appendChild(b);
  });
}

actionSelect.onchange=()=>{
  const v=actionSelect.value; actionSelect.value="";
  if(v==="add"){ tabs.push(tabs.length+1); renderTabs(); }
  if(v==="delete" && confirm("åˆªé™¤ç›®å‰é ï¼Ÿ")){
    tabs=tabs.filter(t=>t!==current);
    current=tabs[0]||1;
    renderTabs(); load(current);
  }
  if(v==="publish") publishHTML();
};

/* ================= ç™¼å¸ƒå™¨ ================= */
function publishHTML(){
  const html = `
<!DOCTYPE html><html><head><meta charset="UTF-8">
<title>${filenameInput.value||"è«æ¯”æ–‡ä»¶"}</title></head>
<body><article>${marked.parse(ta.value)}</article></body></html>`;
  trigger(new Blob([html]),`${filenameInput.value||"article"}.html`);
}

/* ================= ä¸€èˆ¬ä¸‹è¼‰ ================= */
function download(){
  const content = ta.value;
  const ext = formatSelect.value;
  trigger(new Blob([content]),`${filenameInput.value||"note"}.${ext}`);
}

/* ================= åŠ å¯†ä¸‹è¼‰æ ¸å¿ƒ ================= */
async function downloadEncrypted(){
  const password = crypto.getRandomValues(new Uint8Array(16))
    .reduce((s,b)=>s+("0"+b.toString(16)).slice(-2),""); // é«˜å¼·åº¦éš¨æ©Ÿå¯†ç¢¼

  const enc = new TextEncoder().encode(ta.value);
  const iv = crypto.getRandomValues(new Uint8Array(12));

  const key = await crypto.subtle.importKey(
    "raw",
    new TextEncoder().encode(password),
    {name:"PBKDF2"},
    false,
    ["deriveKey"]
  );

  const aes = await crypto.subtle.deriveKey(
    {name:"PBKDF2",salt:new TextEncoder().encode("mobispace"),iterations:100000,hash:"SHA-256"},
    key,{name:"AES-GCM",length:256},false,["encrypt"]
  );

  const cipher = await crypto.subtle.encrypt({name:"AES-GCM",iv},aes,enc);

  const payload = JSON.stringify({
    iv:Array.from(iv),
    data:Array.from(new Uint8Array(cipher))
  });

  // åŒæ™‚ä¸‹è¼‰å…©å€‹æª”æ¡ˆ
  trigger(new Blob([payload]),`${filenameInput.value||"note"}.enc.txt`);
  trigger(new Blob([`Password: ${password}`]),`${filenameInput.value||"note"}_password.txt`);

  alert("å·²ä¸‹è¼‰åŠ å¯†æª” + å¯†ç¢¼æª”ï¼Œè«‹åˆ†é–‹ä¿å­˜ã€‚");
}

/* ================= é€šç”¨ä¸‹è¼‰è§¸ç™¼ ================= */
function trigger(blob,filename){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}
</script>
</body>
</html>
