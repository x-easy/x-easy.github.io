<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />

<!-- ================= SEO / èªæ„æ ¸å¿ƒ ================= -->
<title>è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰</title>
<meta name="description" content="è«æ¯”ç©ºé–“ Mobispace ç§å¯†ç­†è¨˜ Ã— åŠ å¯†ç·¨è¼¯ Ã— ç™¼å¸ƒå¼•æ“">
<meta name="robots" content="index,follow">

<!-- ================= å‹•æ…‹ç¶²ç«™åç¨±è¼ªæ’­ ================= -->
<script>
/* ä½¿ç”¨è€…æŒ‡å®šçš„å¤šçµ„å“ç‰Œåç¨±æ± ï¼ˆåˆ·æ–°æˆ–è¼ªæ’­é¡¯ç¤ºï¼‰ */
const titles = [
  "è«æ¯”æ–‡ä»¶",
  "ç©ºé–“ç·¨è¼¯å™¨",
  "â²˜â³ç·¨è¼¯å™¨",
  "â²˜ğ”¬â²ƒÂ¡ kâ²‰â²‰ğ”­",
  "â³ğ”­â²ğ” â²‰ Nğ”¬tâ²‰",
  "è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰"
];
let tIndex = Math.floor(Math.random()*titles.length);
setInterval(()=>{
  document.title = titles[tIndex++ % titles.length];
}, 4000); // æ¯4ç§’åˆ‡æ›ä¸€æ¬¡å“ç‰Œåç¨±
</script>

<!-- ================= CDN libs ================= -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>

<style>
/* ================= åŸºç¤è¦–è¦ºéª¨æ¶ ================= */
body {
  margin:0;
  background:#000;
  color:#eee;
  font-family:"Noto Sans TC", system-ui;
}

/* ä¸»ç·¨è¼¯å™¨å®¹å™¨ï¼ˆèªæ„ä¸Šç‚ºä¸»è¦åŠŸèƒ½å€å¡Šï¼‰ */
#mobispace-editor {
  max-width: 1100px;
  margin:auto;
  padding:20px;
}

/* é›™æ¬„ç·¨è¼¯æ¶æ§‹ï¼ŒRWD è‡ªå‹•é™ç´šç‚ºå–®æ¬„ */
.editor-main {
  display:grid;
  grid-template-columns:1fr 1fr;
  gap:12px;
}
@media(max-width:768px){
  .editor-main { grid-template-columns:1fr; }
}

/* è¼¸å…¥èˆ‡é è¦½çµ±ä¸€é¢¨æ ¼ */
textarea, #preview, #monaco {
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:10px;
  padding:12px;
  min-height:280px;
}

/* å·¥å…·åˆ—ï¼šä¸‹æ‹‰é‚è¼¯ä¸­æ¨ */
.toolbar {
  display:flex;
  flex-wrap:wrap;
  gap:8px;
  margin:12px 0;
}
select, input, button {
  background:#111;
  color:#fff;
  border:1px solid #333;
  border-radius:6px;
  padding:6px;
}

/* åˆ†é  Tab å€ */
#tabBar {
  display:flex;
  gap:6px;
  flex-wrap:wrap;
  justify-content:center;
  margin-top:12px;
}
.tab {
  background:#333;
  border:none;
  border-radius:6px;
  padding:6px 10px;
  color:#fff;
  cursor:pointer;
}
.tab.active { background:#4caf50; }

/* é å°¾è²æ˜ */
footer {
  margin-top:40px;
  text-align:center;
  font-size:13px;
  color:#666;
}
footer a {
  color:#888;
  text-decoration:none;
}
footer a:hover {
  text-decoration:underline;
}
</style>
</head>

<body>
<section id="mobispace-editor">

<h2 style="text-align:center">è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰</h2>

<!-- ================= å·¥å…·åˆ—æ§åˆ¶æ ¸å¿ƒ ================= -->
<div class="toolbar">

  <select id="modeSelect">
    <option value="normal">ä¸€èˆ¬æ¨¡å¼</option>
    <option value="monaco">IDE æ¨¡å¼</option>
  </select>

  <select id="formatSelect">
    <option value="md">ä¸‹è¼‰ .md</option>
    <option value="txt">ä¸‹è¼‰ .txt</option>
    <option value="html">ä¸‹è¼‰ .html</option>
    <option value="zip">ä¸‹è¼‰ .zip</option>
  </select>

  <input id="filenameInput" placeholder="æª”å" />

  <select id="actionSelect">
    <option value="">æ“ä½œ</option>
    <option value="add">æ–°å¢ç­†è¨˜</option>
    <option value="delete">åˆªé™¤ç­†è¨˜</option>
    <option value="download">ä¸‹è¼‰</option>
    <option value="publish">ä¸€éµç™¼å¸ƒæ–‡ç« é </option>
  </select>

  <input id="passInput" placeholder="åŠ å¯†å¯†ç¢¼" type="password" />
  <button onclick="encryptNote()">åŠ å¯†</button>
  <button onclick="decryptNote()">è§£å¯†</button>
</div>

<!-- ================= ç·¨è¼¯æ ¸å¿ƒ ================= -->
<div class="editor-main">
  <textarea id="textArea" placeholder="è¼¸å…¥ Markdown..."></textarea>
  <div id="preview">Preview</div>
</div>

<div id="monaco" style="display:none;"></div>
<div id="tabBar"></div>

<p id="status" style="text-align:center;font-size:13px;color:#777;">Mobispace Engine Ready</p>

<!-- ================= é å°¾å“ç‰Œè²æ˜ ================= -->
<footer>
  <a href="https://x-easy.github.io" target="_blank">
    è«æ¯”ç©ºé–“ â’¸ â²˜ğ”¬â²ƒÂ¡â³ğ”­â²ğ” â²‰ â€¢ 2025
  </a>
</footer>

</section>

<script>
/* ================= è³‡æ–™åº«å±¤ ================= */
const DB="mobispaceDB", STORE="notes";
let db, current=1, tabs=[1];

indexedDB.open(DB,1).onupgradeneeded=e=>{
  e.target.result.createObjectStore(STORE,{keyPath:"id"});
};
indexedDB.open(DB,1).onsuccess=e=>{
  db=e.target.result;
  load(1);
  renderTabs();
};

/* ================= DOM å¿«æ·ç¶å®š ================= */
const ta=textArea, prev=preview;

/* ================= Markdown æ¸²æŸ“ ================= */
ta.oninput=()=>{
  prev.innerHTML = marked.parse(ta.value); // å³æ™‚è½‰è­¯ Markdown â†’ HTML
  save(); // æ¯æ¬¡è¼¸å…¥å³åŒæ­¥ä¿å­˜
};

/* ================= å„²å­˜ ================= */
function save(){
  db.transaction(STORE,"readwrite").objectStore(STORE)
    .put({id:current,content:ta.value});
}

/* ================= è¼‰å…¥ ================= */
function load(id){
  db.transaction(STORE).objectStore(STORE)
    .get(id).onsuccess=e=>{
      ta.value=e.target.result?.content||"";
      prev.innerHTML = marked.parse(ta.value);
    };
}

/* ================= Tabs æ¸²æŸ“ ================= */
function renderTabs(){
  tabBar.innerHTML="";
  tabs.forEach(id=>{
    const b=document.createElement("button");
    b.className="tab"+(id===current?" active":"");
    b.textContent=id;
    b.onclick=()=>{current=id;load(id);renderTabs();}
    tabBar.appendChild(b);
  });
}

/* ================= æ§åˆ¶ä¸­å¿ƒ ================= */
actionSelect.onchange=()=>{
  const v=actionSelect.value;
  actionSelect.value="";
  if(v==="add"){ tabs.push(tabs.length+1); renderTabs(); }
  if(v==="delete"){
    if(confirm("åˆªé™¤ç›®å‰é ï¼Ÿ")){
      tabs=tabs.filter(t=>t!==current);
      current=tabs[0]||1;
      renderTabs(); load(current);
    }
  }
  if(v==="download") download();
  if(v==="publish") publishHTML();
};

/* ================= ç™¼å¸ƒå™¨ ================= */
function publishHTML(){
  const html = `
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8">
<title>${filenameInput.value||"è«æ¯”æ–‡ä»¶"}</title>
<meta name="description" content="ç”± Mobispace ç™¼å¸ƒ">
</head>
<body>
<article>
${marked.parse(ta.value)}
</article>
</body>
</html>`;
  trigger(new Blob([html]), `${filenameInput.value||"article"}.html`);
}

/* ================= AES åŠ å¯†æ ¸å¿ƒ ================= */
async function getKey(pass){
  const enc=new TextEncoder();
  const key=await crypto.subtle.importKey(
    "raw",
    enc.encode(pass),
    {name:"PBKDF2"},
    false,
    ["deriveKey"]
  );
  return crypto.subtle.deriveKey(
    {name:"PBKDF2",salt:enc.encode("mobispace"),iterations:100000,hash:"SHA-256"},
    key,
    {name:"AES-GCM",length:256},
    false,
    ["encrypt","decrypt"]
  );
}

async function encryptNote(){
  const key=await getKey(passInput.value);
  const iv=crypto.getRandomValues(new Uint8Array(12));
  const enc=new TextEncoder().encode(ta.value);
  const cipher=await crypto.subtle.encrypt({name:"AES-GCM",iv},key,enc);
  ta.value=btoa(JSON.stringify({iv:Array.from(iv),data:Array.from(new Uint8Array(cipher))}));
  ta.oninput();
}

async function decryptNote(){
  const obj=JSON.parse(atob(ta.value));
  const key=await getKey(passInput.value);
  const plain=await crypto.subtle.decrypt(
    {name:"AES-GCM",iv:new Uint8Array(obj.iv)},
    key,
    new Uint8Array(obj.data)
  );
  ta.value=new TextDecoder().decode(plain);
  ta.oninput();
}

/* ================= ä¸‹è¼‰ ================= */
function trigger(blob,filename){
  const a=document.createElement("a");
  a.href=URL.createObjectURL(blob);
  a.download=filename;
  a.click();
}
</script>
</body>
</html>
